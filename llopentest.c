#include "linklayer.h"
void imprime_(char* buf, int bufSize);

int main(int argc, char *argv[]){
    
    if(argc < 3){
        printf("....\n");
        exit(1);
    }

    printf("%s %s\n", argv[1], argv[2]);
    fflush(stdout);

	int receiver = 0, transmiter = 0;
    if (strcmp(argv[2], "tx") == 0)
   	{
		transmiter = 1;
	    printf("tx mode\n");

		// open connection
		struct linkLayer ll;
		    sprintf(ll.serialPort, "%s", argv[1]);
		    ll.role = TRANSMITTER;
		    ll.baudRate = 9600;
		    ll.numTries = 5;
		    ll.timeOut = 3;

    	/*	if(llopen(ll)==-1) {
        		fprintf(stderr, "Could not initialize link layer connection\n");
        		exit(1);
        */
        int res = llopen(ll);
		if(res == -1)    printf("ERROR LLOPEN/RX MODE\n");
        else printf("SUCESS - LLOPEN/RX MODE\n");
   	}
    else if(strcmp(argv[2], "rx") == 0)
   	{
		receiver = 1;
	    printf("rx mode\n");

		// open connection
		struct linkLayer ll;
		    sprintf(ll.serialPort, "%s", argv[1]);
		    ll.role = RECEIVER;
		    ll.baudRate = 9600;
		    ll.numTries = 5;
		    ll.timeOut = 3;

    	/*	if(llopen(ll)==-1) {
        		fprintf(stderr, "Could not initialize link layer connection\n");
        		exit(1);
        */
        /*if(llopen(ll) == -1)    printf("ERROR LLOPEN/RX MODE\n");
        else printf("SUCESS - LLOPEN/RX MODE\n");*/
		int res = llopen(ll);
		if(res == -1)    printf("ERROR LLOPEN/RX MODE\n");
        else printf("SUCESS - LLOPEN/RX MODE\n");
   	}
    else printf("error on parameters\n\n");


	if(transmiter){
		char mensagem[100] = "te~te";
		int size = strlen(mensagem);
		printf("LLWRITE_test: \n");
		int res = llwrite(mensagem, size);
		if(res == -1)	printf("Something went wrong with llwrite :S\n");
	}
	if(receiver){
		char packet[100];
		printf("LLREAD_test: \n");
		int packetSize = llread(packet);
		if(packetSize == -1)	printf("Something went wrong with llread :S\n");
		//imprime_(packet, packetSize);
		packet[packetSize+1] = '\0';
		printf("Margarida? Did u said?? %s??\n", packet);
	}
	
	if(receiver){
		printf("LLCLOSE_test: \n");
		int res = llclose(FALSE);
		if(res == -1)	printf("Something went wrong with llclose :S\n");
		else printf("Connection close! Dont talk with me any more >:-( \n");
	}

    return 0;
}

void imprime_(char* buf, int bufSize){
  if((!buf)||(bufSize<0)) return;
  for(int i = 0; i < bufSize; i++){
    printf("%02x ", buf[i]);
  }
  printf("\n");
}